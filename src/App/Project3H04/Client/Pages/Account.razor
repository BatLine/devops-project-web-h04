@page "/account"
<!--AUTH-->
@attribute [Authorize]
@inject HttpClient httpClient
@inject ISidepanelService Sidepanel
<div class="container-fluid m-0 vh-100">
    <div class="row vh-100">
        <div class="col-3 p-0">
            <nav id="sidebar">
                <div class="row justify-content-center">
                    <div class="col-6 p-4">
                        <div class="rounded-circle image">
                            <img src="/images/@kunst.Fotopad" alt="" />
                        </div>
                    </div>
                </div>
                <ul class="list-unstyled mb-5">
                    <li>
                        <a role="button" @onclick="ShowProfile">profile</a>
                    </li>
                    @*Ik zou gwn zonder links doen en op 1 pagina de info tonen, tis te weinig info om in tabs op te delen*@
                    @*Enkel abonnement miss*@

                    @if (geb is Kunstenaar_DTO)
                    {
                        <li>
                            <a role="button">subscription</a>
                        </li>
                        <!--authorize kunstenaar-->
                        <li>
                            <a role="button" @onclick="ShowArtworks">artworks</a>
                        </li>
                    }

                </ul>
            </nav>
        </div>
        <div class="col-9 p-3">

            <!--=> Bewerken moet nog !!!-->
            <!-- Page Content  -->
            <!--eerst de algemene attributen als geb tonen en dan bv voor bestellingen of kunstwerken te tonen, de klant of kunstenaar obj gebruiken !!!-->
            <!--algemene dingen tonen met bestellingen en als kunstenaar(AuthorizeView) dan vanonder of een tab om als kunstenaar uw kunstwerken te zien en te editen-->
            @*<EditAccount GebruikerId="@geb.GebruikerId" gebruiker="@geb" />*@
            <!--hier de extra als kunstenaar dan zijn kunstwerken tonen-->

            @if (showProfile == true)
            {
                @if (editForm == false)
                {

                    <p> Username: @geb.Gebruikersnaam</p>
                    <p> Day of birth: @geb.GeboorteDatum</p>
                    <p> Email: @geb.Email</p>
                    <p> Details: @geb.Details</p>

                    <button type="button" @onclick="ShowEditForm" class="button is-link is-light is-fullwidth">Edit</button>
                }
                else
                {<!--met sidepanel-->
                    <EditAccount GebruikerId="@geb.GebruikerId" gebruiker="@geb" OnRedirect="callback" /><!-- hoe na de edit, de editForm bool terug op false zetten?-->
                    <button type="button" class="button is-link is-light is-fullwidth" @onclick="Showgeg">Return</button>
                }

            }
            @if (showArtworks)
            {
                <EditArtworks kunstenaar="@kunst" />
            }

        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private Gebruiker_DTO geb = new Gebruiker_DTO();
    private Klant_DTO klant = new Klant_DTO();
    private Kunstenaar_DTO kunst = new Kunstenaar_DTO();
    private bool editForm = false; //TODO: hoe na de edit, de editForm bool terug op false zetten?

    private bool showArtworks = false;
    private bool showProfile = true;
    //zo geen hard refresh door callback mee te geven aan de edit form
    EventCallback callback;
    protected override async Task OnParametersSetAsync()
    {
        //de user ophalen uit auth en kijken welke soort user het is
        //|| of => user als geb ophalen en dan kijken welke type het is(kunst of klant) en dan de user met authorizeview roles = "Kunstenaar"
        //voor algemene attributen de geb gebruiken

        var user = (await authenticationStateTask).User;
        if (user.Identity != null) {
            Console.WriteLine(user.Identity.Name);
            Console.WriteLine(user.IsInRole("Kunstenaar"));
            //Console.WriteLine(user.Claims.FirstOrDefault().Value == "Kunstenaar");
        }
        if (user.IsInRole("Kunstenaar")) {
            kunst = await httpClient.GetFromJsonAsync<Kunstenaar_DTO>($"api/Kunstenaar/byEmail/{user.Identity.Name}");
            geb = kunst;
            Console.WriteLine("Kunst");
        } else {
            klant = await httpClient.GetFromJsonAsync<Klant_DTO>($"api/Klant/byEmail/{user.Identity.Name}");
            geb = klant;
            //Console.WriteLine(klant.Email);
            Console.WriteLine("Klant");
        }
    }

    public void ShowEditForm() {
        editForm = true;
        callback = EventCallback.Factory.Create(this, RedirectPage);
    }

    public void Showgeg() {
        editForm = false;
    }
    public void ShowProfile()
    {
        showProfile = true;
        editForm = false;
        showArtworks = false;
    }

    public void ShowArtworks()
    {
        showArtworks = true;
        showProfile = false;
    }
    private async Task RedirectPage()
    {
        this.OnParametersSetAsync();

    }
    //public void OpenEditSidePanel()
    //{
    //    var parameters = new Dictionary<string, object>
    //        {
    //            { nameof(Components.EditAccount.GebruikerId), geb.GebruikerId },
    //            { nameof(Components.EditAccount.gebruiker), geb}
    //        };
    //    Sidepanel.Open<Components.EditAccount>("", parameters); //lmpao, gg sidepanel

    //}
}